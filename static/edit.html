{{template "header.html" .}}
<title>记事编辑</title>

<div>
    <table id=edit>
        {{if .T.readonly}}
        <tr style='background:#ffe0b2'>
            <td colspan=2>
                <div class=display>
                    <b style='word-break:break-all;white-space:pre-wrap;margin-right:0.5em'>{{.T.note.Title}}</b>
                    <span>{{formatUnixMilli .T.recordUnix}} 的历史记录</span>
                </div>
            </td>
        </tr>
        {{end}}

        {{with .T.note}}
        {{if .PendingReview}}
        <tr style='background:#fffddd'>
            <td class=small>待审核</td>
            <td>
                <script type="text/plain" id=content{{.Id}}>{{.Content}}</script>
                <script type="text/plain" id=review-content{{.Id}}>{{.ReviewContent}}</script>

                <div class=display>
                    <div style='flex-grow:1'>{{.ReviewTitle}}</div>
                    <div class='tag-box button' onclick='openDiff("content{{.Id}}","review-content{{.Id}}",true)'><span>内容diff</span></div>
                    {{if not $.T.readonly}}
                    <div class='tag-box button' onclick='ajaxBtn(this,"/ns:action",{"action":"approve","id":{{.Id}}})'><span>通过</span></div>
                    <div class='tag-box button' onclick='ajaxBtn(this,"/ns:action",{"action":"reject","id":{{.Id}}})'><span>驳回</span></div>
                    {{end}}
                </div>
            </td>
        </tr>
        {{end}}

        <tr>
            <td class=small>ID</td>
            <td>
                <div class=display>
                    <span>{{.Id}}&nbsp;</span>
                    <a class='tag-edit-button li_eye' href='/{{.EscapedTitle}}'></a>
                </div>
            </td>
        </tr>
        <tr>
            <td class=small>标题</td>
            <td>
                <div class=display>
                    <script type="text/plain" id=title{{.Id}}>{{.Title}}</script>
                    <input id="title" maxlength={{$.GetTitleMaxLen}} class=tag-edit-name {{if $.T.readonly}}readonly{{end}}/>
                    {{if not $.T.readonly}}
                    <div class='tag-box button' onclick='updateNote(this)' id=update style='display:none'><span>更新</span></div>
                    {{end}}
                </div>
            </td>
        </tr>
        <tr>
            <td class=small>内容</td>
            <td>
                <div class=display>
                    <textarea
                        {{if $.T.readonly}}readonly{{end}}
                        maxlength={{$.GetContentMaxLen}}
                        id="content"
                        class=tag-edit-desc
                        style='height:10em'>{{.Content}}</textarea>
                </div>
            </td>
        </tr>

        <tr><td class=small>父记事</td><td><div class=display id=parents-container><div class=lds-dual-ring></div></div></td></tr>
        <tr><td class=small>变更历史</td><td><div class=display><a href='/ns:history?note={{.Id}}&desc=1'>查看</a></div></td></tr>
        <tr>
            <td class=small>状态</td>
            <td>
                <div class=display>
                    <span>{{if .Lock}}<b>锁定中</b>{{else}}正常{{end}}&nbsp;</span>
                    {{if not $.T.readonly}}
                    <div class='tag-edit-button button' action=''
                         onclick='ajaxBtn(this, "/ns:action", {"action": {{if .Lock}}"Unlock"{{else}}"Lock"{{end}}, "id": {{.Id}}})'>
                        <span class=li_lock></span>
                    </div>
                    {{end}}
                </div>
            </td>
        </tr>
        <tr>
            <td class=small>创建者</td>
            <td>
                <div class=display>
                    {{.Creator}}&nbsp;
                    <a class='tag-edit-button' href='/ns:manage?pid={{.Creator}}'><span class=li_user></span></a>
                </div>
            </td>
        </tr>
        <tr><td class=small>创建时间</td><td><div class=display>{{formatUnixMilli .CreateUnix}}</div></td></tr>
        <tr><td class=small>最近修改人</td><td><div class=display>{{.Modifier}}</div></td></tr>
        <tr><td class=small>最近审核人</td><td><div class=display>{{.Reviewer}}</div></td></tr>
        <tr><td class=small>修改时间</td><td><div class=display>{{formatUnixMilli .UpdateUnix}}</div></td></tr>

        {{if not $.T.readonly}}
        <tr>
            <td class=small></td>
            <td>
                <div class=display>
                    <div class='tag-box button alert' onclick='deleteNote(this)'><span>删除记事</span></div>
                </div>
            </td>
        </tr>
        {{end}}

        <script>
            $.get('/ns:search?n=100&ids={{.JoinParentIds}}', function(data) {
                const ps = $("<div max-tags={{$.GetParentsMax}} class='tag-search-input-container border1' style='width:100%'></div>").get(0);
                $('#parents-container').html('').append(ps);
                ps.onclicktag = function(id) { location.href='/ns:edit?id='+id; }
                data.notes.forEach(function(t, i) { $(ps).attr('tag-data' + i, t[0] + ',' + t[1]) });
                wrapTagSearchInput(ps);
                window.ps = ps;
                $('#update').show();
            });
            $('#title').val($('#title{{.Id}}').text());
            $('#content').linedtextarea();

            function updateNote(btn) {
                ajaxBtn(btn, "/ns:action", {
                    'action': 'update',
                    'id': {{.Id}},
                    'title': $("#title").val(),
                    'content': $("#content").val(),
                    'parents': JSON.stringify(window.ps.getTags()),
                });
            }

            function deleteNote(btn) {
                if (!confirm("确认删除该记事?")) return;
                ajaxBtn(btn, '/ns:action', {'action': 'delete', 'id': {{.Id}}}, function(data) {
                    location.href = '/ns:manage?desc=1';
                });
            }
        </script>
        {{end}}
    </table>
</div>

{{template "footer.html" .}}

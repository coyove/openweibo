{{template "header.html" .}}
<title>记事编辑</title>

<div>
    <table id=edit>
        {{if .T.readonly}}
        <tr style='background:#ffe0b2'>
            <td colspan=2>
                <div class=display>
                    <b style='word-break:break-all;white-space:pre-wrap;margin-right:0.5em'>{{.T.note.HTMLTitleDisplay}}</b>
                    <span>{{formatUnixMilli .T.recordUnix}} 的历史记录</span>
                </div>
            </td>
        </tr>
        {{end}}

        {{with .T.note}}
        {{if .PendingReview}}
        <tr style='background:#fffddd'>
            <td class=small>待审核</td>
            <td>
                <div class=display>
                    <div style='flex-grow:1'>{{safeHTML .ReviewTitle}}</div>
                    {{if not $.T.readonly}}
                    <div class='tag-box button' onclick='ajaxBtn(this,"approve",{"id":{{.Id}}})'><span>通过</span></div>
                    <div class='tag-box button' onclick='ajaxBtn(this,"reject",{"id":{{.Id}}})'><span>驳回</span></div>
                    {{end}}
                </div>
            </td>
        </tr>
        {{end}}

        <tr>
            <td class=small>ID</td>
            <td>
                <div class=display>
                    <span>{{.Id}}&nbsp;</span>
                    <a class='tag-edit-button li_eye' href='/{{.EscapedTitle}}'></a>
                </div>
            </td>
        </tr>
        <tr>
            <td class=small>标题</td>
            <td>
                <div class=display>
                    <script type="text/plain" id=title{{.Id}}>{{.Title}}</script>
                    <input id="title" maxlength={{$.GetTitleMaxLen}} class=tag-edit-name {{if $.T.readonly}}readonly{{end}}/>
                    {{if not $.T.readonly}}
                    <div class='tag-box button' onclick='updateNote(this)' id=update style='display:none'><span>更新</span></div>
                    {{end}}
                </div>
            </td>
        </tr>
        {{if and (not $.User.IsMod) (ne $.UserDisplay .Creator) (not $.T.readonly)}}
        <tr>
            <td class=small></td>
            <td>
                <div class=display style='font-size:90%;    word-break: break-all; white-space: pre-wrap;'
                    >修改将会由创建者或管理员审核后生效，在此之前你可以驳回自己的修改或进一步编辑。</div>
            </td>
        </tr>
        {{end}}
        <tr>
            <td class=small>图片</td>
            <td>
                <div class=display>
                    <input id="image" type=file class='image-selector' {{if .PendingReview}}title='现图片'{{end}} accept="image/*">
                    <input readonly id="review-image" type=file class='image-selector' style='display:none' title='新图片'>
                </div>
            </td>
        </tr>
        {{if .PendingReview}}
        <tr>
            <td class=small></td>
            <td>
                <div class=display>
                    <label><input onclick='switchDiffView(this)' type=radio name=diff value=current checked> 原内容&emsp;</label>
                    <label><input onclick='switchDiffView(this)' type=radio name=diff value=review> 新内容&emsp;</label>
                    <label><input onclick='switchDiffView(this)' type=radio name=diff value=diff> Diff内容&emsp;</label>
                </div>
            </td>
        </tr>
        {{end}}
        <tr id='tr-content-current'>
            <td class=small>内容</td>
            <td>
                <div class=display>
                    <textarea id="content"
                        {{if $.T.readonly}}readonly{{end}}
                        maxlength={{$.GetContentMaxLen}}
                        class=tag-edit-desc
                        style='height:10em'>{{safeHTML .Content}}</textarea>
                </div>
            </td>
        </tr>
        {{if .PendingReview}}
        <tr id='tr-content-review' style='display:none'>
            <td class=small>新内容</td>
            <td>
                <div class=display>
                    <textarea id="review-content" readonly class=tag-edit-desc style='height:10em'
                        >{{safeHTML .ReviewContent}}</textarea>
                </div>
            </td>
        </tr>
        <tr id='tr-content-diff' style='display:none'>
            <td class=small>Diff</td><td><div class=display><div id=diff style='width: 100%'></div></div></td>
        </tr>
        {{end}}

        <tr><td class=small>父记事</td><td><div class=display id=parents-container><div class=lds-dual-ring></div></div></td></tr>
        <tr><td class=small>变更历史</td><td><div class=display><a href='/ns:history?note={{.Id}}&desc=1'>查看</a></div></td></tr>
        <tr>
            <td class=small>状态</td>
            <td>
                <div class=display>
                    <span>{{if .Lock}}<b>锁定中</b>{{else}}正常{{end}}&nbsp;</span>
                    {{if not $.T.readonly}}
                    <div class='tag-edit-button button' action=''
                         onclick='ajaxBtn(this,{{if .Lock}}"Unlock"{{else}}"Lock"{{end}}, {"id": {{.Id}}})'>
                        <span class=li_lock></span>
                    </div>
                    {{end}}
                </div>
            </td>
        </tr>
        <tr>
            <td class=small>创建者</td>
            <td>
                <div class=display>
                    {{.Creator}}&nbsp;
                    <a class='tag-edit-button' href='/ns:manage?pid={{.Creator}}'><span class=li_user></span></a>
                </div>
            </td>
        </tr>
        <tr><td class=small>创建时间</td><td><div class=display>{{formatUnixMilli .CreateUnix}}</div></td></tr>
        <tr><td class=small>最近修改人</td><td><div class=display>{{.Modifier}}</div></td></tr>
        <tr><td class=small>最近审核人</td><td><div class=display>{{.Reviewer}}</div></td></tr>
        <tr><td class=small>修改时间</td><td><div class=display>{{formatUnixMilli .UpdateUnix}}</div></td></tr>

        {{if not $.T.readonly}}
        <tr>
            <td class=small></td>
            <td>
                <div class=display>
                    <div class='tag-box button alert' onclick='deleteNote(this)'><span>删除记事</span></div>
                </div>
            </td>
        </tr>
        {{end}}

        <script>
            $.get('/ns:search?n=100&ids={{.JoinParentIds}}', function(data) {
                const ps = $("<div max-tags={{$.GetParentsMax}} class='tag-search-input-container border1' style='width:100%'></div>").get(0);
                $('#parents-container').html('').append(ps);
                ps.onclicktag = function(id) { location.href='/ns:edit?id='+id; }
                data.notes.forEach(function(t, i) { $(ps).attr('tag-data' + i, t[0] + ',' + t[1]) });
                wrapTagSearchInput(ps);
                window.ps = ps;
                $('#update').show();
            });
            $('#title').val($('#title{{.Id}}').text());
            $('#image').imageSelector("{{imageURL "thumb" .Image}}");
            $('#content').linedtextarea();
            {{if .PendingReview}}
            {{if ne .Image .ReviewImage}}
            $('#review-image').imageSelector("{{imageURL "thumb" .ReviewImage}}");
            {{end}}
            $('#review-content').linedtextarea();
            const diff = JsDiff.diffLines($('#content').val(), $('#review-content').val());
            var fragment = document.createDocumentFragment();
            for (var i=0; i < diff.length; i++) {
                if (diff[i].added && diff[i + 1] && diff[i + 1].removed) {
                    var swap = diff[i];
                    diff[i] = diff[i + 1];
                    diff[i + 1] = swap;
                }

                var node = document.createElement('div');
                if (diff[i].removed) {
                    node.className = 'diff-row del';
                } else if (diff[i].added) {
                    node.className = 'diff-row ins';
                } else {
                    node.className = 'diff-row';
                }
                node.appendChild(document.createTextNode(diff[i].value || ' '));
                fragment.appendChild(node);
            }
            $('#diff').append(fragment);
            {{end}}

            function updateNote(btn) {
                ajaxBtn(btn, "update", {
                    'id': {{.Id}},
                    'title': $("#title").val(),
                    'content': $("#content").val(),
                    'image': $('#image').get(0).files[0],
                    'thumb': $('#image').get(0).thumb,
                    'image_changed': $('#image').attr('changed'),
                    'parents': JSON.stringify(window.ps.getTags()),
                });
            }

            function deleteNote(btn) {
                if (!confirm("确认删除该记事?")) return;
                ajaxBtn(btn, 'delete', {'id': {{.Id}}}, function(data) {
                    location.href = '/ns:manage?desc=1';
                });
            }

            function switchDiffView(i) {
                $('[id^="tr-content-"]').hide();
                $("#tr-content-" + i.value).show().css('min-height','10em');
            }
        </script>
        {{end}}
    </table>
</div>

{{template "footer.html" .}}

{{template "header.html" .}}

<style>
body { min-width: 1000px}
.uplot, .uplot *, .uplot *::before, .uplot *::after {box-sizing: border-box;}.uplot {font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";line-height: 1.5;width: min-content;}.u-title {text-align: center;font-size: 18px;font-weight: bold;}.u-wrap {position: relative;user-select: none;}.u-over, .u-under {position: absolute;}.u-under {overflow: hidden;}.uplot canvas {display: block;position: relative;width: 100%;height: 100%;}.u-legend {font-size: 14px;margin: auto;text-align: center;}.u-inline {display: block;}.u-inline * {display: inline-block;}.u-inline tr {margin-right: 16px;}.u-legend th {font-weight: 600;}.u-legend th > * {vertical-align: middle;display: inline-block;}.u-legend .u-marker {width: 1em;height: 1em;margin-right: 4px;background-clip: content-box !important;}.u-inline.u-live th::after {content: ":";vertical-align: middle;}.u-inline:not(.u-live) .u-value {display: none;}.u-series > * {padding: 4px;}.u-series th {cursor: pointer;}.u-legend .u-off > * {opacity: 0.3;}.u-select {background: rgba(0,0,0,0.07);position: absolute;pointer-events: none;}.u-cursor-x, .u-cursor-y {position: absolute;left: 0;top: 0;pointer-events: none;will-change: transform;z-index: 100;}.u-hz .u-cursor-x, .u-vt .u-cursor-y {height: 100%;border-right: 1px dashed #607D8B;}.u-hz .u-cursor-y, .u-vt .u-cursor-x {width: 100%;border-bottom: 1px dashed #607D8B;}.u-cursor-pt {position: absolute;top: 0;left: 0;border-radius: 50%;pointer-events: none;will-change: transform;z-index: 100; background-clip: content-box !important;}.u-select.u-off, .u-cursor-x.u-off, .u-cursor-y.u-off, .u-cursor-pt.u-off {display: none;}
.u-legend { box-shadow: none; display: flex }
.u-inline * { flex-basis: 25%; text-align: center; display: flex }
.u-inline th { flex-wrap: nowrap; display: flex; align-items: center }
.u-inline td { flex-grow: 1 }
.u-inline tr { margin: 0 !important; background: transparent !important }
.u-legend th > * { white-space: nowrap }
</style>


<table>
    <tr>
        <td>
            <div class=display>
                选择指标:&emsp;
                {{range .T.nss}}
                <a style='margin-right: 0.5em' href="javascript:show('{{.}}')">{{.}}</a>
                {{end}}
            </div>
        </td>
    </tr>
    <tr>
        <td>
            <div id=lat style='padding:0.5em; width:100%'></div>
        </td>
    </tr>
</table>

<script src='https://cdn.jsdelivr.net/npm/uplot@1.6.7/dist/uPlot.iife.min.js'></script>
<script>
    const M = ({{.T.metrics}});
    function show(ns) {
        var data = M[ns];
        const latChart = document.getElementById('lat');
        latChart.innerHTML = '';
            if (!data) data = [{"Index": {{.T.start}}000}];

        const showQPS = ['s3upload', 'create'].includes(ns);
        const opts = {
            id: "chart1",
            title: ns,
            width: latChart.getBoundingClientRect().width - 1,
            height: 400,
            series: [{}, {
                show: !showQPS,
                spanGaps: false,
                label: '平均时延 (ms)',
                width: 1,
                value: (self, rawValue) => rawValue.toFixed(3),
                stroke: "hsla(110, 50%, 47%, 1)",
                fill: "hsla(110, 50%, 47%, 0.3)",
            }, {
                show: !showQPS,
                spanGaps: false,
                label: '最大时延 (ms)',
                width: 1,
                value: (self, rawValue) => rawValue.toFixed(3),
                stroke: "hsla(180, 50%, 47%, 1)",
                fill: "hsla(180, 50%, 47%, 0.3)",
            }, {
                show: true, 
                spanGaps: false,
                label: 'QPS',
                width: 1,
                value: (self, rawValue) => rawValue.toFixed(3),
                stroke: "hsla(240, 50%, 47%, 1)",
                fill: "hsla(240, 50%, 47%, 0.3)",
            }],
        };

        var payload = [[], [], [], []];
        data.forEach(function(i) {
            payload[0].push(i.Index);
            payload[1].push(i.Avg / 1000);
            payload[2].push(i.Max / 1000);
            payload[3].push(i.Count / 300);
        });

        if (showQPS) {
            opts.series = [{}, opts.series[3]];
            payload = [payload[0], payload[3]];
        }

        new uPlot(opts, payload, latChart)
    }

    show('');
</script>

{{template "footer.html" .}}

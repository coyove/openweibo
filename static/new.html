{{template "header.html" .}}
<title>新建记事</title>
<table>
    <tr>
        <td class=small>标题</td>
        <td>
            <div class=display>
                <input id=name maxlength={{.GetTitleMaxLen}} class='tag-edit-name' placeholder='{{.GetTitleMaxLen}}字符' />
                <div id=dup style='display:none'><b>重名</b><a class='tag-edit-button icon-eye' style='margin-left:0.5em'></a></div>
                <div id=submit class='tag-box button'><span>创建</span></div>
            </div>
        </td>
    </tr>
    <tr>
        <td class=small>图片</td>
        <td>
            <div class=display>
                <input id="image" type=file class='image-selector' accept="image/*">
            </div>
        </td>
    </tr>
    <tr>
        <td class=small>内容</td>
        <td>
            <div class=display>
                <textarea id=desc maxlength={{.GetContentMaxLen}} class=tag-edit-desc placeholder='{{.GetContentMaxLen}}字符' rows=20></textarea>
            </div>
        </td>
    </tr>
    <tr>
        <td class=small></td>
        <td><div class=display style='font-size:90%'>关于高级语法，请阅读该篇<a href='/ns:edit_syntax'>记事</a>。</div></td>
    </tr>
    <tr>
        <td class=small>父记事</td>
        <td><div class=display id=parents></div></td>
    </tr>
    <tr>
        <td class=small></td><td><div class=display style='font-size:90%'>标题为空时，请选择至少一个父记事。</div></td>
    </tr>
</table>

        <script>
            $('#submit').click(function() {
                ajaxBtn(this, 'create', {
                    'title': $('#name').val(),
                    'content': $('#desc').val(),
                    'image': $('#image').get(0).files[0],
                    'thumb': $('#image').get(0).thumb,
                    'image_changed': $('#image').attr('changed'),
                    'parents': JSON.stringify(ps.get(0).getTags()),
                }, function(data) {
                    pTitle ? 
                        (location.href = '/' + encodeURIComponent(pTitle) + '?sort=0&desc=1') :
                        (location.href = '/ns:manage?sort=0&desc=1')
                });
            })
            $('#desc').linedtextarea();
            $('#image').imageSelector();

            const searchParams = new URLSearchParams(window.location.search)
            const pre = searchParams.get('pt');
            const title = searchParams.get('title');
            const ps = $("<div max-tags={{.GetParentsMax}} id=parents class='tag-search-input-container border1' style='width:100%'></div>");
            ps.get(0).onclicktag = function(id) { window.open('/ns:edit?id='+id) }

            pre && ps.attr('tag-data0', pre);
            title && $('#name').val(title.substr(0, {{.GetTitleMaxLen}}));
            const pTitle = pre ? pre.substr(pre.indexOf(',') + 1) : '';

            $('#parents').append(ps);

            function checkTitle() {
                function reset() {
                    $('#submit').show();
                    $('#dup').hide().closest('tr').css('background', '');
                }
                const that = this, last = this.last || '', input = $('#name').val();
                if (!input) reset();
                if (input && input != last) {
                    $.get('/ns:search?n=1&title=' + encodeURIComponent(input), function(data) {
                        if (data.notes.length > 0 && $('#name').val() == input) {
                            $('#submit').hide();
                            $('#dup').show().find('a').attr('href', '/' + encodeURIComponent(input)).closest('tr').css('background', '#fce4ec')
                        } else {
                            reset();
                        }
                    }).always(function() {
                        that.last = input;
                        setTimeout(checkTitle, 200);
                    })
                } else {
                    this.last = input;
                    setTimeout(checkTitle, 200);
                }
            }
            checkTitle();
        </script>

{{template "footer.html" .}}

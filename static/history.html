{{template "header.html" .}}
<title>修改历史</title>

<style>
.diff {
    display: flex;
    line-height: 2em;
}
.diff-header {
    font-size:90%; white-space:initial;line-height:1.25em;margin:0.2em 0;
    align-items:center; display:flex; flex-grow: 1;
}
.diff-header-ip {
    font-size:90%; color: #aaa;
}
</style>

<script>
    function diff() {
        const left = $('input[type=radio][name=diff-left]:checked').val();
        const right = $('input[type=radio][name=diff-right]:checked').val();
        if (!left || !right) return;
        const diff = JsDiff.diffLines(
            $('#record' + left).find('.content').text(),
            $('#record' + right).find('.content').text(),
        );
        var fragment = document.createDocumentFragment();
        for (var i=0; i < diff.length; i++) {
            if (diff[i].added && diff[i + 1] && diff[i + 1].removed) {
                var swap = diff[i];
                diff[i] = diff[i + 1];
                diff[i + 1] = swap;
            }

            var node = document.createElement('div');
            if (diff[i].removed) {
                node.className = 'diff-row del';
            } else if (diff[i].added) {
                node.className = 'diff-row ins';
            } else {
                node.className = 'diff-row';
            }
            node.appendChild(document.createTextNode(diff[i].value || ' '));
            fragment.appendChild(node);
        }
        const dialog = $("<div class=dialog>").
            append($("<div class=display style='padding:0.5em;background:#f1f2f3'><div class='button tag-edit-button'>" + window.CONST_closeSVG + "</div></div>")).
            append(fragment);
        dialog.find('.button').click(function() {
            dialog.remove();
            document.body.style.overflow = '';
        });
        document.body.appendChild(dialog.get(0));
        document.body.style.overflow = 'hidden';
    }
</script>

<div>
    <table id=list>
        <tr class=title>
            <td colspan=2>
                <div class=display >
                    <div style='flex-grow:1'>
                        {{if eq .T.viewType "note"}}
                            <b class=wrapall>{{.T.note.HTMLTitleDisplay}}</b>
                            <a class=tag-edit-button href='/{{.T.note.EscapedTitle}}'><span class=li_eye></span></a>
                            <a class=tag-edit-button href='/ns:edit?id={{.T.note.Id}}'><span class=li_pen></span></a>
                            修改历史
                        {{end}}

                        {{if eq .T.viewType "user"}}
                            <a class=tag-edit-button href='/ns:manage?sort=0&pid={{.T.id}}'><span class=li_vynil></span></a>
                            {{if eq .UserDisplay .T.id}}我的{{else}}{{.T.id}} {{end}}修改历史
                        {{end}}

                        {{if eq .T.viewType "all"}}
                            <span>全站修改历史</span>
                        {{end}}
                        <span>({{.T.total}})</span>
                    </div>
                    <div>
                        <a class='tag-edit-button icon-sort-number-up {{if not .T.desc}}selected{{end}}' href='/ns:history?{{.T.viewType}}={{.T.id}}'></a>
                        <a class='tag-edit-button icon-sort-number-down {{if .T.desc}}selected{{end}}' href='/ns:history?{{.T.viewType}}={{.T.id}}&desc=1'></a>
                    </div>
                </div>
            </td>
        </tr>
        {{range .T.records}}
        {{$tagid := .Note.Id}}
        <tr>
            <td>
                {{if eq $.T.viewType "note"}}
                <input onclick='diff()' name=diff-left value={{.Id}} type=radio>
                <input onclick='diff()' name=diff-right value={{.Id}} type=radio>
                {{end}}
                <b>{{.ActionName}}</b>
            </td>
            <td>
                <div class=diff>
                    <div class='diff-header'>
                        {{.Modifier}}&nbsp;
                        <a href='/ns:history?user={{.Modifier}}&desc=1' class='tag-edit-button li_user'></a>&nbsp;
                    </div>
                    <div class=diff-header-ip>{{.ModifierIP}}</div>
                </div>
            </td>
        </tr>
        <tr id='record{{.Id}}'>
            <td class='small'><div>{{formatUnixMilliBR .CreateUnix}}</div></td>
            {{$rid := .Id}}
            {{with .Note}}
            <td tag-id={{.Id}} class='tag-edit'>
                <textarea style='display:none' class=content>{{safeHTML .Content}}</textarea>
                <div class=display>
                    {{imageBox .Image}}
                    <div style='flex-grow:1;white-space:pre-wrap'><a href='/ns:edit?hid={{$rid}}'>{{.HTMLTitleDisplay}}</a></div>
                </div>
            </td>
            {{end}}
        </tr>
        {{end}}
    </table>
</div>

<div id=page style='text-align:center'>
    {{range (generatePages .T.page .T.pages)}}
        {{if eq . 0}}
        <span>...</span>
        {{else}}
        <div class='tag-box nav-page button {{if eq . $.T.page}}selected{{end}}'>
            {{if eq . $.T.page}}
            <span><b>{{.}}</b></span>
            {{else}}
            <a href='?{{$.BuildPageLink .}}&{{$.T.viewType}}={{$.T.id}}'>{{.}}</a>
            {{end}}
        </div>
        {{end}}
    {{end}}
</div>
{{template "footer.html" .}}
